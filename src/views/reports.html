<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EncuestAPPs - Reports</title>

    <style>
        /* ... (Estilos CSS sin cambios) ... */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f7fdf9;
            display: flex;
        }

        /* SIDEBAR */
        .sidebar {
            width: 220px;
            background: #0f6b33;
            color: white;
            height: 100vh;
            padding: 20px 0;
            position: fixed;
            left: 0;
            top: 0;
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
        }

        .menu-item {
            padding: 12px 20px;
            cursor: pointer;
        }

        .menu-item:hover,
        .active {
            background: #0a4d25;
        }

        /* MAIN */
        .main {
            flex: 1;
            padding: 20px 40px;
            margin-left: 220px;
            width: calc(100% - 220px);
        }

        .top-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-box {
            display: flex;
            align-items: center;
            background: #e8f5e9;
            padding: 8px 15px;
            border-radius: 20px;
            margin-right: 10px;
        }

        .user-box span {
            margin-left: 8px;
            font-weight: bold;
        }

        .logout-btn {
            background: #d9534f;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
        }

        /* TABLE */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        th, td {
            padding: 14px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        th {
            background: #0f6b33;
            color: white;
        }

        .btn-export {
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
        }

        .btn-pdf {
            background: #d9534f;
            color: white;
        }

        .btn-xlsx {
            background: #0f6b33;
            color: white;
        }

    </style>
</head>

<body>

    <div class="sidebar">
        <h2>EncuestAPPs</h2>

        <div class="menu-item" onclick="location.href='http://localhost:3000/dashboard'">Dashboard</div>
        <div class="menu-item" onclick="location.href='http://localhost:3000/surveys'">Surveys</div>
        <div class="menu-item active" onclick="location.href='http://localhost:3000/reports'">Reports</div>
        <div class="menu-item">Users</div>
        <div class="menu-item">Company Settings</div>
    </div>

    <div class="main">

        <div class="top-bar">
            <div class="user-box">
                <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" width="28">
                <span id="userName">User</span> |
                <span id="userRole" style="margin-left: 5px; color:#0f6b33;"></span>
            </div>

            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <h1>Reports</h1>

        <div style="text-align: center;"> 
            <button class="btn-export btn-xlsx" onclick="exportXLSX()">Survey Report XSL</button>
            <button class="btn-export btn-pdf" onclick="exportPDF()">Survey Report PDF</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Survey Title</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Status</th>
                </tr>
            </thead>

            <tbody id="surveyTableBody">
                </tbody>
        </table>

    </div>

<script>
    // USER VALIDATION
    const user = JSON.parse(localStorage.getItem("userData"));
    const idEmpresa = user ? user.idEmpresa : null; // Capturar idEmpresa de forma segura
    
    if (!user) {
        window.location.href = "http://localhost:3000/login";
    }

    // Only allow SupAdmin & Analista
    if (user.perfil !== "SupAdmin" && user.perfil !== "Analista") {
        alert("Access denied.");
        window.location.href = "http://localhost:3000/dashboard";
    }

    document.getElementById("userName").textContent = user.nombre;
    document.getElementById("userRole").textContent = user.perfil;
    
    // GET SURVEYS FROM CORRECT BACKEND ROUTE
    async function cargarEncuestas() {
        if (!idEmpresa) return; // Salir si no hay idEmpresa

        try {
            const res = await fetch(`http://localhost:3000/api/empresa/${idEmpresa}`);
            const encuestas = await res.json();

            const tbody = document.getElementById("surveyTableBody");
            tbody.innerHTML = "";

            encuestas.forEach(enc => {
                tbody.innerHTML += `
                    <tr>
                        <td>${enc.idEncuesta}</td>
                        <td>${enc.titulo}</td>
                        <td>${enc.fechaInicio.split("T")[0]}</td>
                        <td>${enc.fechaFin.split("T")[0]}</td>
                        <td>${enc.estado}</td>
                    </tr>
                `;
            });

        } catch (err) {
            console.error("Error loading surveys:", err);
        }
    }

    cargarEncuestas();

    // EXPORT XLSX
    function exportXLSX() {
        if (!idEmpresa) {
            alert("No se pudo obtener el ID de la Empresa.");
            return;
        }
        window.location.href = `http://localhost:3000/api/exportar/${idEmpresa}/excel`;
    }

    // EXPORT PDF
    function exportPDF() {
        if (!idEmpresa) {
            alert("No se pudo obtener el ID de la Empresa.");
            return;
        }
        window.location.href = `http://localhost:3000/api/exportar/${idEmpresa}/pdf`;
    }


    function logout() {
        localStorage.removeItem("userData");
        window.location.href = "http://localhost:3000/login";
    }
</script>

</body>
</html>